<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦–å°”åœ°åŒºå®Œæ•´æµ‹è¯• - è§†é¢‘ä¸‹è½½å™¨</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .test-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
        }
        .test-title {
            color: #1976d2;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .section-title {
            color: #333;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .url-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .test-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            transition: transform 0.2s;
        }
        .test-btn:hover {
            transform: translateY(-2px);
        }
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #28a745;
            background-color: #d4edda;
        }
        .error {
            border-left: 4px solid #dc3545;
            background-color: #f8d7da;
        }
        .warning {
            border-left: 4px solid #ffc107;
            background-color: #fff3cd;
        }
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            background: linear-gradient(90deg, #4caf50, #81c784);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        .test-urls {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .url-item {
            margin: 5px 0;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
        }
        .url-item:hover {
            background: #e8eaf6;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ready { background: #ccc; }
        .status-testing { background: #ff9800; }
        .status-success { background: #4caf50; }
        .status-error { background: #f44336; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-title">ğŸŒ é¦–å°”åœ°åŒºå®Œæ•´æµ‹è¯• - è§†é¢‘ä¸‹è½½å™¨</div>
        <p>æµ‹è¯•é¦–å°”åœ°åŒºYouTube/Bç«™è§†é¢‘ä¸‹è½½ï¼ŒéªŒè¯é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶</p>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalTests">0</div>
                <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successCount">0</div>
                <div class="stat-label">æˆåŠŸä¸‹è½½</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="retryCount">0</div>
                <div class="stat-label">è‡ªåŠ¨é‡è¯•</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="errorCount">0</div>
                <div class="stat-label">é”™è¯¯å¤„ç†</div>
            </div>
        </div>

        <!-- æ‰‹åŠ¨æµ‹è¯•åŒºåŸŸ -->
        <div class="test-section">
            <div class="section-title">ğŸ¯ æ‰‹åŠ¨æµ‹è¯•</div>
            <input type="text" id="testUrl" class="url-input" placeholder="è¾“å…¥è§†é¢‘URLè¿›è¡Œæµ‹è¯•...">
            <div>
                <button class="test-btn" onclick="testVideoInfo()">æµ‹è¯•è§†é¢‘ä¿¡æ¯</button>
                <button class="test-btn" onclick="testDownload()">æµ‹è¯•ä¸‹è½½</button>
                <button class="test-btn" onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
            </div>
            <div id="manualResult" class="result-box" style="display:none;"></div>
            <div id="progressContainer" style="display:none;">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
                </div>
                <div id="progressText"></div>
            </div>
        </div>

        <!-- é¢„è®¾URLæµ‹è¯• -->
        <div class="test-section">
            <div class="section-title">ğŸ“‹ é¢„è®¾URLæµ‹è¯•ï¼ˆé¦–å°”åœ°åŒºå¸¸è§é—®é¢˜ï¼‰</div>
            <div class="test-urls">
                <div class="url-item" onclick="setTestUrl('https://www.youtube.com/watch?v=dQw4w9WgXcQ')">
                    <span class="status-indicator status-ready" id="status-1"></span>
                    YouTubeæµ‹è¯•è§†é¢‘ (åœ°åŒºé™åˆ¶æµ‹è¯•)
                </div>
                <div class="url-item" onclick="setTestUrl('https://www.bilibili.com/video/BV1xx411c7mu')">
                    <span class="status-indicator status-ready" id="status-2"></span>
                    Bç«™æµ‹è¯•è§†é¢‘ (ç½‘ç»œè¿æ¥æµ‹è¯•)
                </div>
                <div class="url-item" onclick="setTestUrl('https://www.youtube.com/watch?v=invalid_video_id')">
                    <span class="status-indicator status-ready" id="status-3"></span>
                    æ— æ•ˆURLæµ‹è¯• (é”™è¯¯å¤„ç†æµ‹è¯•)
                </div>
            </div>
            <button class="test-btn" onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        </div>

        <!-- é”™è¯¯å¤„ç†æµ‹è¯• -->
        <div class="test-section">
            <div class="section-title">ğŸ” é”™è¯¯å¤„ç†éªŒè¯</div>
            <div id="errorHandlingResult" class="result-box" style="display:none;"></div>
            <button class="test-btn" onclick="testErrorHandling()">æµ‹è¯•é”™è¯¯å¤„ç†æœºåˆ¶</button>
        </div>

        <!-- è¯¦ç»†æ—¥å¿— -->
        <div class="test-section">
            <div class="section-title">ğŸ“ è¯¦ç»†æµ‹è¯•æ—¥å¿—</div>
            <div id="detailedLog" class="result-box" style="display:none;"></div>
        </div>
    </div>

    <script>
        let totalTests = 0;
        let successCount = 0;
        let retryCount = 0;
        let errorCount = 0;
        let currentDownloadId = null;
        let progressInterval = null;

        function updateStats() {
            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('retryCount').textContent = retryCount;
            document.getElementById('errorCount').textContent = errorCount;
        }

        function logToDetailed(message) {
            const log = document.getElementById('detailedLog');
            log.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function setTestUrl(url) {
            document.getElementById('testUrl').value = url;
            logToDetailed(`è®¾ç½®æµ‹è¯•URL: ${url}`);
        }

        async function testVideoInfo() {
            const url = document.getElementById('testUrl').value;
            if (!url) {
                alert('è¯·è¾“å…¥è§†é¢‘URL');
                return;
            }

            totalTests++;
            updateStats();
            logToDetailed(`å¼€å§‹æµ‹è¯•è§†é¢‘ä¿¡æ¯: ${url}`);

            const result = document.getElementById('manualResult');
            result.style.display = 'block';
            result.textContent = 'æ­£åœ¨è·å–è§†é¢‘ä¿¡æ¯...';
            result.className = 'result-box';

            try {
                const response = await fetch('/video-info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                const data = await response.json();
                
                if (response.ok) {
                    result.className = 'result-box success';
                    result.textContent = `âœ… è§†é¢‘ä¿¡æ¯è·å–æˆåŠŸ:\næ ‡é¢˜: ${data.title}\næ—¶é•¿: ${data.duration}\nå¹³å°: ${data.platform}`;
                    successCount++;
                    logToDetailed(`âœ… è§†é¢‘ä¿¡æ¯è·å–æˆåŠŸ: ${data.title}`);
                } else {
                    result.className = 'result-box error';
                    const errorInfo = `âŒ è·å–å¤±è´¥:\né”™è¯¯ç±»å‹: ${data.error_type || 'æœªçŸ¥'}\næ˜¯å¦è‡´å‘½: ${data.fatal ? 'æ˜¯' : 'å¦'}\nè¯¦ç»†ä¿¡æ¯: ${data.error}`;
                    result.textContent = errorInfo;
                    
                    if (!data.fatal) {
                        result.textContent += '\n\nğŸ”„ è¿™æ˜¯å¯é‡è¯•çš„é”™è¯¯ï¼Œä¸‹è½½æ—¶ä¼šè‡ªåŠ¨é‡è¯•';
                        retryCount++;
                        logToDetailed(`ğŸ”„ å¯é‡è¯•é”™è¯¯: ${data.error_type} - ${data.error}`);
                    } else {
                        errorCount++;
                        logToDetailed(`âŒ è‡´å‘½é”™è¯¯: ${data.error_type} - ${data.error}`);
                    }
                }
            } catch (error) {
                result.className = 'result-box error';
                result.textContent = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
                errorCount++;
                logToDetailed(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }

            updateStats();
        }

        async function testDownload() {
            const url = document.getElementById('testUrl').value;
            if (!url) {
                alert('è¯·è¾“å…¥è§†é¢‘URL');
                return;
            }

            totalTests++;
            updateStats();
            logToDetailed(`å¼€å§‹æµ‹è¯•ä¸‹è½½: ${url}`);

            const result = document.getElementById('manualResult');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            result.style.display = 'block';
            progressContainer.style.display = 'block';
            
            result.textContent = 'æ­£åœ¨å¯åŠ¨ä¸‹è½½...';
            result.className = 'result-box';

            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentDownloadId = data.download_id;
                    result.textContent = `âœ… ä¸‹è½½å·²å¯åŠ¨ï¼ŒID: ${currentDownloadId}`;
                    logToDetailed(`âœ… ä¸‹è½½å·²å¯åŠ¨ï¼ŒID: ${currentDownloadId}`);
                    
                    // å¼€å§‹è½®è¯¢è¿›åº¦
                    progressInterval = setInterval(checkProgress, 1000);
                } else {
                    result.className = 'result-box error';
                    result.textContent = `âŒ å¯åŠ¨ä¸‹è½½å¤±è´¥: ${data.error}`;
                    progressContainer.style.display = 'none';
                    errorCount++;
                    logToDetailed(`âŒ å¯åŠ¨ä¸‹è½½å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                result.className = 'result-box error';
                result.textContent = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
                progressContainer.style.display = 'none';
                errorCount++;
                logToDetailed(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }

            updateStats();
        }

        async function checkProgress() {
            if (!currentDownloadId) return;

            try {
                const response = await fetch(`/progress/${currentDownloadId}`);
                const data = await response.json();

                if (response.ok) {
                    const progressFill = document.getElementById('progressFill');
                    const progressText = document.getElementById('progressText');
                    const result = document.getElementById('manualResult');

                    progressFill.style.width = `${data.percent || 0}%`;
                    progressText.textContent = `${data.message} (${(data.percent || 0).toFixed(1)}%)`;

                    if (data.status === 'completed') {
                        clearInterval(progressInterval);
                        result.className = 'result-box success';
                        result.textContent = `âœ… ä¸‹è½½å®Œæˆ!\næ–‡ä»¶å: ${data.filename}\nä¸‹è½½é“¾æ¥: ${window.location.origin}/download-file/${currentDownloadId}`;
                        successCount++;
                        logToDetailed(`âœ… ä¸‹è½½å®Œæˆ: ${data.filename}`);
                        updateStats();
                    } else if (data.status === 'failed') {
                        clearInterval(progressInterval);
                        result.className = 'result-box error';
                        
                        let errorInfo = `âŒ ä¸‹è½½å¤±è´¥:\nçŠ¶æ€: ${data.status}\næ¶ˆæ¯: ${data.message}`;
                        
                        if (data.error_type) {
                            errorInfo += `\né”™è¯¯ç±»å‹: ${data.error_type}`;
                        }
                        if (data.fatal !== undefined) {
                            errorInfo += `\næ˜¯å¦è‡´å‘½: ${data.fatal ? 'æ˜¯' : 'å¦'}`;
                        }
                        if (data.error) {
                            errorInfo += `\nè¯¦ç»†é”™è¯¯: ${data.error}`;
                        }

                        result.textContent = errorInfo;

                        if (!data.fatal) {
                            result.textContent += '\n\nğŸ”„ è¿™æ˜¯å¯é‡è¯•çš„é”™è¯¯ï¼Œå»ºè®®é‡æ–°ä¸‹è½½';
                            retryCount++;
                            logToDetailed(`ğŸ”„ å¯é‡è¯•é”™è¯¯: ${data.error_type} - ${data.error}`);
                        } else {
                            errorCount++;
                            logToDetailed(`âŒ è‡´å‘½é”™è¯¯: ${data.error_type} - ${data.error}`);
                        }
                        
                        updateStats();
                    }
                } else {
                    clearInterval(progressInterval);
                    const result = document.getElementById('manualResult');
                    result.className = 'result-box error';
                    result.textContent = `âŒ è·å–è¿›åº¦å¤±è´¥: ${data.error}`;
                    errorCount++;
                    logToDetailed(`âŒ è·å–è¿›åº¦å¤±è´¥: ${data.error}`);
                    updateStats();
                }
            } catch (error) {
                clearInterval(progressInterval);
                const result = document.getElementById('manualResult');
                result.className = 'result-box error';
                result.textContent = `âŒ è¿›åº¦æŸ¥è¯¢å¤±è´¥: ${error.message}`;
                errorCount++;
                logToDetailed(`âŒ è¿›åº¦æŸ¥è¯¢å¤±è´¥: ${error.message}`);
                updateStats();
            }
        }

        async function testErrorHandling() {
            const result = document.getElementById('errorHandlingResult');
            result.style.display = 'block';
            result.textContent = 'æ­£åœ¨æµ‹è¯•é”™è¯¯å¤„ç†æœºåˆ¶...\n';
            result.className = 'result-box';

            const testCases = [
                { type: 'åœ°åŒºé™åˆ¶', message: 'è¯¥è§†é¢‘åœ¨å½“å‰åœ°åŒºä¸å¯è§‚çœ‹' },
                { type: 'SSLé”™è¯¯', message: 'SSLè¯ä¹¦éªŒè¯å¤±è´¥ï¼Œç½‘ç»œç¯å¢ƒå¯èƒ½æœ‰é—®é¢˜' },
                { type: 'ç½‘ç»œé”™è¯¯', message: 'ç½‘ç»œè¿æ¥è¶…æ—¶' },
                { type: 'æœªçŸ¥é”™è¯¯', message: 'æœªçŸ¥çš„ä¸‹è½½é”™è¯¯' }
            ];

            logToDetailed('å¼€å§‹é”™è¯¯å¤„ç†æœºåˆ¶æµ‹è¯•');

            for (const testCase of testCases) {
                // æ¨¡æ‹Ÿé”™è¯¯å¤„ç†å‡½æ•°
                const mockError = {
                    error_type: testCase.type.toLowerCase().replace(/[^a-z]/g, '_'),
                    fatal: false, // é¦–å°”åœ°åŒºæ‰€æœ‰é”™è¯¯éƒ½åº”è¯¥æ˜¯å¯é‡è¯•çš„
                    user_friendly: testCase.message
                };

                result.textContent += `\næµ‹è¯• ${testCase.type}:\n`;
                result.textContent += `  é”™è¯¯ç±»å‹: ${mockError.error_type}\n`;
                result.textContent += `  æ˜¯å¦è‡´å‘½: ${mockError.fatal ? 'æ˜¯' : 'å¦'}\n`;
                result.textContent += `  ç”¨æˆ·å‹å¥½æç¤º: ${mockError.user_friendly}\n`;
                
                if (!mockError.fatal) {
                    result.textContent += `  âœ… ç¬¦åˆé¦–å°”åœ°åŒºç­–ç•¥ - å¯é‡è¯•\n`;
                    logToDetailed(`âœ… ${testCase.type} - å¯é‡è¯•é”™è¯¯å¤„ç†æ­£ç¡®`);
                } else {
                    result.textContent += `  âŒ ä¸ç¬¦åˆé¦–å°”åœ°åŒºç­–ç•¥ - è¢«è¯¯åˆ¤ä¸ºè‡´å‘½é”™è¯¯\n`;
                    logToDetailed(`âŒ ${testCase.type} - é”™è¯¯è¢«è¯¯åˆ¤ä¸ºè‡´å‘½é”™è¯¯`);
                }
            }

            result.className = 'result-box success';
            result.textContent += '\nğŸ¯ é”™è¯¯å¤„ç†æœºåˆ¶æµ‹è¯•å®Œæˆ';
            logToDetailed('é”™è¯¯å¤„ç†æœºåˆ¶æµ‹è¯•å®Œæˆ');
        }

        async function runAllTests() {
            const urls = [
                'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
                'https://www.bilibili.com/video/BV1xx411c7mu',
                'https://www.youtube.com/watch?v=invalid_video_id'
            ];

            logToDetailed('å¼€å§‹è¿è¡Œæ‰€æœ‰é¢„è®¾æµ‹è¯•');

            for (let i = 0; i < urls.length; i++) {
                setTestUrl(urls[i]);
                
                // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                const statusIndicator = document.getElementById(`status-${i + 1}`);
                statusIndicator.className = 'status-indicator status-testing';
                
                await testVideoInfo();
                
                // ç­‰å¾…ä¸€ç§’å†ç»§ç»­ä¸‹ä¸€ä¸ªæµ‹è¯•
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                statusIndicator.className = successCount > i ? 'status-indicator status-success' : 'status-indicator status-error';
            }

            logToDetailed('æ‰€æœ‰é¢„è®¾æµ‹è¯•å®Œæˆ');
        }

        function clearResults() {
            document.getElementById('manualResult').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('errorHandlingResult').style.display = 'none';
            document.getElementById('detailedLog').style.display = 'none';
            
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            currentDownloadId = null;
            
            // é‡ç½®ç»Ÿè®¡
            totalTests = 0;
            successCount = 0;
            retryCount = 0;
            errorCount = 0;
            updateStats();
            
            // é‡ç½®çŠ¶æ€æŒ‡ç¤ºå™¨
            for (let i = 1; i <= 3; i++) {
                const statusIndicator = document.getElementById(`status-${i}`);
                if (statusIndicator) {
                    statusIndicator.className = 'status-indicator status-ready';
                }
            }
            
            logToDetailed('æµ‹è¯•ç»“æœå·²æ¸…ç©º');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logToDetailed('é¦–å°”åœ°åŒºå®Œæ•´æµ‹è¯•é¡µé¢å·²åŠ è½½');
            logToDetailed('å‡†å¤‡è¿›è¡Œè§†é¢‘ä¸‹è½½å™¨æµ‹è¯•...');
        });
    </script>
</body>
</html>
