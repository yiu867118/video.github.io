<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘ä¸‹è½½å™¨ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .test-section h3 {
            color: #495057;
            margin-top: 0;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus {
            border-color: #667eea;
            outline: none;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .device-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            color: #0d47a1;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 12px;
        }
        
        .sample-urls {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .sample-urls h4 {
            margin-top: 0;
            color: #856404;
        }
        
        .sample-urls ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .sample-urls li {
            margin-bottom: 5px;
            word-break: break-all;
        }
        
        .quick-test-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .quick-test-buttons button {
            font-size: 12px;
            padding: 8px 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ è§†é¢‘ä¸‹è½½å™¨ä¿®å¤æµ‹è¯•</h1>
        
        <div class="device-info">
            <strong>è®¾å¤‡ä¿¡æ¯:</strong> <span id="deviceInfo"></span><br>
            <strong>ç”¨æˆ·ä»£ç†:</strong> <span id="userAgent"></span>
        </div>
        
        <div class="sample-urls">
            <h4>ğŸ“‹ æµ‹è¯•ç”¨URLç¤ºä¾‹</h4>
            <ul>
                <li><strong>YouTube:</strong> https://www.youtube.com/watch?v=dQw4w9WgXcQ</li>
                <li><strong>Bilibili:</strong> https://www.bilibili.com/video/BV1xx411c7mu</li>
                <li><strong>Bilibili:</strong> https://www.bilibili.com/video/BV1GJ411x7h7</li>
            </ul>
        </div>
        
        <!-- æµ‹è¯•1: è§†é¢‘ä¿¡æ¯è·å– -->
        <div class="test-section">
            <h3>ğŸ§ª æµ‹è¯•1: è§†é¢‘ä¿¡æ¯è·å–</h3>
            <div class="input-group">
                <label for="infoUrl">è§†é¢‘é“¾æ¥:</label>
                <input type="text" id="infoUrl" placeholder="è¯·è¾“å…¥YouTubeæˆ–Bilibiliè§†é¢‘é“¾æ¥">
            </div>
            <button onclick="testVideoInfo()">è·å–è§†é¢‘ä¿¡æ¯</button>
            <div class="quick-test-buttons">
                <button onclick="quickTest('info', 'https://www.youtube.com/watch?v=dQw4w9WgXcQ')">æµ‹è¯•YouTube</button>
                <button onclick="quickTest('info', 'https://www.bilibili.com/video/BV1xx411c7mu')">æµ‹è¯•Bç«™1</button>
                <button onclick="quickTest('info', 'https://www.bilibili.com/video/BV1GJ411x7h7')">æµ‹è¯•Bç«™2</button>
            </div>
            <div id="infoResult" class="result" style="display: none;"></div>
        </div>
        
        <!-- æµ‹è¯•2: å®é™…ä¸‹è½½ -->
        <div class="test-section">
            <h3>ğŸ§ª æµ‹è¯•2: å®é™…ä¸‹è½½æµ‹è¯•</h3>
            <div class="input-group">
                <label for="downloadUrl">è§†é¢‘é“¾æ¥:</label>
                <input type="text" id="downloadUrl" placeholder="è¯·è¾“å…¥è¦ä¸‹è½½çš„è§†é¢‘é“¾æ¥">
            </div>
            <button onclick="testDownload()" id="downloadBtn">å¼€å§‹ä¸‹è½½æµ‹è¯•</button>
            <div class="quick-test-buttons">
                <button onclick="quickTest('download', 'https://www.youtube.com/watch?v=dQw4w9WgXcQ')">ä¸‹è½½YouTube</button>
                <button onclick="quickTest('download', 'https://www.bilibili.com/video/BV1xx411c7mu')">ä¸‹è½½Bç«™1</button>
            </div>
            
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="downloadResult" class="result" style="display: none;"></div>
        </div>
        
        <!-- æµ‹è¯•3: æ–‡ä»¶åæ¸…ç†æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ§ª æµ‹è¯•3: æ–‡ä»¶åæ¸…ç†æµ‹è¯•</h3>
            <div class="input-group">
                <label for="filenameTest">æµ‹è¯•æ ‡é¢˜:</label>
                <input type="text" id="filenameTest" placeholder="è¾“å…¥åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ ‡é¢˜" value="ã€æµ‹è¯•è§†é¢‘ã€‘è¿™æ˜¯ä¸€ä¸ª<æµ‹è¯•>æ ‡é¢˜ï¼šåŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Ÿï¼">
            </div>
            <button onclick="testFilenameClean()">æµ‹è¯•æ–‡ä»¶åæ¸…ç†</button>
            <button onclick="testMultipleFilenames()">æ‰¹é‡æµ‹è¯•</button>
            <div id="filenameResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
        document.getElementById('deviceInfo').textContent = getDeviceInfo();
        document.getElementById('userAgent').textContent = navigator.userAgent;
        
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            if (/Android/i.test(ua)) return 'Android ç§»åŠ¨è®¾å¤‡';
            if (/iPhone/i.test(ua)) return 'iPhone';
            if (/iPad/i.test(ua)) return 'iPad';
            if (/Mobile/i.test(ua)) return 'ç§»åŠ¨è®¾å¤‡';
            return 'æ¡Œé¢è®¾å¤‡';
        }
        
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
        
        function quickTest(type, url) {
            if (type === 'info') {
                document.getElementById('infoUrl').value = url;
                testVideoInfo();
            } else if (type === 'download') {
                document.getElementById('downloadUrl').value = url;
                testDownload();
            }
        }
        
        async function testVideoInfo() {
            const url = document.getElementById('infoUrl').value.trim();
            if (!url) {
                showResult('infoResult', 'è¯·è¾“å…¥è§†é¢‘é“¾æ¥', 'error');
                return;
            }
            
            showResult('infoResult', 'æ­£åœ¨è·å–è§†é¢‘ä¿¡æ¯...', 'info');
            
            try {
                const response = await fetch('/video-info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const info = `âœ… è§†é¢‘ä¿¡æ¯è·å–æˆåŠŸï¼
ğŸ“ æ ‡é¢˜: ${result.title}
â±ï¸ æ—¶é•¿: ${result.duration} ç§’
ğŸ¬ å¹³å°: ${result.platform}
ğŸ‘¤ ä¸Šä¼ è€…: ${result.uploader || 'æœªçŸ¥'}
âœ… å¯ç”¨æ€§: ${result.available ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}`;
                    showResult('infoResult', info, 'success');
                } else {
                    showResult('infoResult', `âŒ è·å–å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('infoResult', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testDownload() {
            const url = document.getElementById('downloadUrl').value.trim();
            if (!url) {
                showResult('downloadResult', 'è¯·è¾“å…¥è§†é¢‘é“¾æ¥', 'error');
                return;
            }
            
            const downloadBtn = document.getElementById('downloadBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'ä¸‹è½½ä¸­...';
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            
            showResult('downloadResult', 'æ­£åœ¨å¯åŠ¨ä¸‹è½½...', 'info');
            
            try {
                // å¯åŠ¨ä¸‹è½½
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });
                
                const result = await response.json();
                
                if (response.ok && result.download_id) {
                    // è½®è¯¢è¿›åº¦
                    pollProgress(result.download_id);
                } else {
                    throw new Error(result.error || 'ä¸‹è½½å¯åŠ¨å¤±è´¥');
                }
            } catch (error) {
                showResult('downloadResult', `âŒ ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
                resetDownloadUI();
            }
        }
        
        async function pollProgress(downloadId) {
            try {
                const response = await fetch(`/progress/${downloadId}`);
                const progress = await response.json();
                
                if (response.ok) {
                    // æ›´æ–°è¿›åº¦æ¡
                    const progressFill = document.getElementById('progressFill');
                    progressFill.style.width = `${progress.percent || 0}%`;
                    
                    // æ›´æ–°çŠ¶æ€ä¿¡æ¯
                    let statusText = `çŠ¶æ€: ${progress.status}
è¿›åº¦: ${progress.percent || 0}%
æ¶ˆæ¯: ${progress.message || ''}`;
                    
                    if (progress.speed) {
                        statusText += `
é€Ÿåº¦: ${progress.speed}`;
                    }
                    
                    if (progress.downloaded_mb) {
                        statusText += `
å·²ä¸‹è½½: ${progress.downloaded_mb.toFixed(1)} MB`;
                    }
                    
                    if (progress.status === 'completed') {
                        statusText += `
âœ… ä¸‹è½½å®Œæˆï¼
ğŸ“ æ–‡ä»¶å: ${progress.filename || 'æœªçŸ¥'}`;
                        
                        if (progress.download_url) {
                            statusText += `
ğŸ”— ä¸‹è½½é“¾æ¥: ${progress.download_url}`;
                        }
                        
                        showResult('downloadResult', statusText, 'success');
                        resetDownloadUI();
                    } else if (progress.status === 'failed') {
                        statusText += `
âŒ ä¸‹è½½å¤±è´¥: ${progress.error || 'æœªçŸ¥é”™è¯¯'}`;
                        showResult('downloadResult', statusText, 'error');
                        resetDownloadUI();
                    } else {
                        showResult('downloadResult', statusText, 'info');
                        // ç»§ç»­è½®è¯¢
                        setTimeout(() => pollProgress(downloadId), 2000);
                    }
                } else {
                    throw new Error(progress.error || 'è·å–è¿›åº¦å¤±è´¥');
                }
            } catch (error) {
                showResult('downloadResult', `âŒ è¿›åº¦è·å–å¤±è´¥: ${error.message}`, 'error');
                resetDownloadUI();
            }
        }
        
        function resetDownloadUI() {
            const downloadBtn = document.getElementById('downloadBtn');
            const progressBar = document.getElementById('progressBar');
            
            downloadBtn.disabled = false;
            downloadBtn.textContent = 'å¼€å§‹ä¸‹è½½æµ‹è¯•';
            progressBar.style.display = 'none';
        }
        
        function testFilenameClean() {
            const title = document.getElementById('filenameTest').value.trim();
            if (!title) {
                showResult('filenameResult', 'è¯·è¾“å…¥æµ‹è¯•æ ‡é¢˜', 'error');
                return;
            }
            
            // æ¨¡æ‹Ÿæ–‡ä»¶åæ¸…ç†é€»è¾‘
            const cleaned = cleanFilename(title);
            const result = `åŸå§‹æ ‡é¢˜: ${title}
æ¸…ç†åæ ‡é¢˜: ${cleaned}
é•¿åº¦: ${cleaned.length}
æ˜¯å¦å®‰å…¨: ${isFilenameSafe(cleaned) ? 'âœ… æ˜¯' : 'âŒ å¦'}`;
            
            showResult('filenameResult', result, 'success');
        }
        
        function testMultipleFilenames() {
            const testTitles = [
                'ã€æµ‹è¯•è§†é¢‘ã€‘è¿™æ˜¯ä¸€ä¸ª<æµ‹è¯•>æ ‡é¢˜ï¼šåŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Ÿï¼',
                'Test Video with English & Chinese ä¸­æ–‡æ ‡é¢˜',
                'å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿çš„æ ‡é¢˜',
                'Title/with\\illegal|chars*and:more?',
                'æ™®é€šæ ‡é¢˜',
                ''
            ];
            
            let result = 'æ‰¹é‡æ–‡ä»¶åæ¸…ç†æµ‹è¯•ç»“æœ:\n\n';
            
            testTitles.forEach((title, index) => {
                const cleaned = cleanFilename(title);
                result += `${index + 1}. åŸå§‹: "${title}"
   æ¸…ç†: "${cleaned}"
   é•¿åº¦: ${cleaned.length}
   å®‰å…¨: ${isFilenameSafe(cleaned) ? 'âœ…' : 'âŒ'}
\n`;
            });
            
            showResult('filenameResult', result, 'success');
        }
        
        // ç®€å•çš„æ–‡ä»¶åæ¸…ç†å‡½æ•°ï¼ˆæ¨¡æ‹Ÿåç«¯é€»è¾‘ï¼‰
        function cleanFilename(title) {
            if (!title || !title.trim()) {
                return 'Unknown_Video';
            }
            
            // æ›¿æ¢ä¸å®‰å…¨å­—ç¬¦
            const replacements = {
                '<': 'ï¼œ',
                '>': 'ï¼',
                ':': 'ï¼š',
                '"': "'",
                '/': 'ï¼',
                '\\': 'ï¼¼',
                '|': 'ï½œ',
                '?': 'ï¼Ÿ',
                '*': 'ï¼Š',
                'ã€': '[',
                'ã€‘': ']',
                'ï¼ˆ': '(',
                'ï¼‰': ')',
            };
            
            let cleaned = title;
            for (const [old, newChar] of Object.entries(replacements)) {
                cleaned = cleaned.replace(new RegExp(old.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), newChar);
            }
            
            // æ¸…ç†é¦–å°¾ç©ºæ ¼å’Œç‚¹
            cleaned = cleaned.trim().replace(/^[._-]+|[._-]+$/g, '');
            
            // é™åˆ¶é•¿åº¦
            if (cleaned.length > 120) {
                cleaned = cleaned.substring(0, 120);
                // å°è¯•åœ¨åˆé€‚ä½ç½®æˆªæ–­
                const lastSpace = Math.max(
                    cleaned.lastIndexOf(' '),
                    cleaned.lastIndexOf('-'),
                    cleaned.lastIndexOf('_')
                );
                if (lastSpace > 96) {
                    cleaned = cleaned.substring(0, lastSpace);
                }
            }
            
            cleaned = cleaned.trim();
            
            return cleaned || 'Unknown_Video';
        }
        
        // æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦å®‰å…¨
        function isFilenameSafe(filename) {
            const unsafeChars = /[<>:"/\\|?*]/;
            return !unsafeChars.test(filename) && filename.length > 0 && filename.length <= 255;
        }
    </script>
</body>
</html>
